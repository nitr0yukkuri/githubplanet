<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設定 - GitHub Planet</title>
    <link rel="icon" href="/front/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="./front/css/settings.css">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .settings-container {
            width: 90%;
            max-width: 600px;
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        h1 {
            border-bottom: 1px solid #30363d;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .title-editor {
            margin-bottom: 2rem;
        }

        .preview-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: #58a6ff;
            font-weight: bold;
        }

        .selectors {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        select {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 1rem;
            flex: 1;
        }

        .save-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .save-btn:hover {
            background: #2ea043;
        }

        .back-button {
            display: inline-block;
            margin-top: 1rem;
            color: #8b949e;
            text-decoration: none;
        }

        .back-button:hover {
            color: #58a6ff;
        }
    </style>
</head>

<body>
    <div class="settings-container">
        <h1>Settings</h1>

        <div class="title-editor">
            <h2>称号の変更</h2>
            <p style="font-size: 0.9rem; color: #8b949e; margin-bottom: 1rem;">実績を解除すると新しい言葉が増えます。</p>

            <div class="preview-box">
                <span id="preview-prefix"></span> <span id="preview-suffix"></span>
            </div>

            <div class="selectors">
                <select id="prefix-select"></select>
                <select id="suffix-select"></select>
            </div>

            <button id="save-btn" class="save-btn">保存する</button>
        </div>

        <a href="/" class="back-button">＜ 惑星に戻る</a>
    </div>

    <script>
        const prefixSelect = document.getElementById('prefix-select');
        const suffixSelect = document.getElementById('suffix-select');
        const previewPrefix = document.getElementById('preview-prefix');
        const previewSuffix = document.getElementById('preview-suffix');
        const saveBtn = document.getElementById('save-btn');

        let currentPrefix = '';
        let currentSuffix = '';

        function updatePreview() {
            currentPrefix = prefixSelect.value;
            currentSuffix = suffixSelect.value;
            previewPrefix.textContent = currentPrefix;
            previewSuffix.textContent = currentSuffix;
        }

        prefixSelect.addEventListener('change', updatePreview);
        suffixSelect.addEventListener('change', updatePreview);

        saveBtn.addEventListener('click', async () => {
            try {
                const res = await fetch('/api/save-title', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prefix: currentPrefix, suffix: currentSuffix })
                });
                if (res.ok) {
                    alert('称号を保存しました！');
                } else {
                    alert('保存に失敗しました。');
                }
            } catch (e) {
                console.error(e);
                alert('通信エラーが発生しました。');
            }
        });

        async function init() {
            try {
                const res = await fetch('/api/me');
                if (!res.ok) {
                    document.querySelector('.settings-container').innerHTML = '<p>ログインが必要です。</p><a href="/" class="back-button">戻る</a>';
                    return;
                }
                const data = await res.json();
                const { planetData } = data;

                const unlocked = planetData.unlockedTitles || { prefixes: ['名もなき'], suffixes: ['旅人'] };
                const active = planetData.activeTitle || { prefix: '名もなき', suffix: '旅人' };

                // 選択肢の生成
                unlocked.prefixes.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = p;
                    if (p === active.prefix) opt.selected = true;
                    prefixSelect.appendChild(opt);
                });

                unlocked.suffixes.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    if (s === active.suffix) opt.selected = true;
                    suffixSelect.appendChild(opt);
                });

                updatePreview();

            } catch (e) {
                console.error('Error fetching settings:', e);
            }
        }

        init();
    </script>
</body>

</html>